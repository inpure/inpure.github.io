---
title: 计算机网络通信 OSI 模型、TCP-IP协议栈
tags: OSI TCP/IP
---

介绍 OSI 七层模型和 TCP-IP 四层协议栈。

<!--more-->
## 1.OSI模型

![](/assets/image_Linux/OSI.png)
共7层：

1. 应用层
2. 表示层
3. 会话层
4. 传输层  
   segment 段, 可靠tcp,非udp
5. 网络层  
   packet, 逻辑ip, 路由
6. 数据链路层  
   frame 帧, 物理MAC 
7. 物理层  
   bit 

### 发送数据

从1到7进行封装

### 冲突域

两个主机各自发单播数据引发冲突，就在一个冲突域

### 广播域

一个主机发广播数据，其他主机能收到，这些主机就在一个广播域  
广播地址：48个1

### 接收数据

从7到1解封装

### 网卡

工作在数据链路层和物理层

### 集线器HUB

多端口中继器，  
工作在物理层，  
半双工，  
只管广播数据，不记录MAC，  
共享带宽，  
属于一个冲突域  
简单说就是个连接器

### 网桥

- 数据链路层
- 两个端口，一般配合HUB集线器 使用
- 学习源地址，转发看目标地址  
- 可以分割冲突域 ，不能隔离广播域
- 历史产品，现在少用了

### 交换机switch

- 数据链路层
- 取代网桥，有点像网桥的立交桥版，有多个端口直接连主机，
- 每个端口一个冲突域，全双工
- 不能隔断广播域

### 路由器router

- 分隔广播域
- 选择路由表中到达目标最好的路径
- 连接广域网
- route -n : 查路由表
- 路由表记录IP地址，网络层设备

### VLAN

VLAN = 广播域 = 逻辑网络，解决交换机不能隔断广播域的问题

- 分割广播域
- 安全
- 灵活管理
- 交换机可以分出多个VLAN
- VLN之间通讯需要路由器

### 相关命令

- `mii-tool -v eth0`或 `ethtool eth0` 查网卡信息

## 2.TCP/IP协议栈

### 应用层

- 相当于OSI的应用层、表示层、会话层  
- 常见协议：http80,https443,ftp21,nfs,dns53,tftp69,smtp25,pop3110
,imap,telnet23,ssh22,msql3306,qq(私有协议)  
- 查看协议命令：cat /etc/services

### 传输层

同OSI的传输层

- 协议：udp和tcp

#### TCP特性

- 工作在传输层
- 面向连接协议
- 全双工协议
- 半关闭
- 错误检查
- 将数据打包成段，排序
- 确认机制
- 数据恢复，重传
- 流量控制，滑动窗口
- 拥塞控制，慢启动和拥塞避免算法

##### TCP包头 

![TCP包头](/assets/image_Linux/TCP包头.png)

- 源端口、目标端口：计算机上的进程要和其他进程通信是要通过计算机端口的，而一个计算机端口某个时刻只能被一个进程占用，所以通过指定源端口和目标端口，就可以知道是哪两个进程需要通信。源端口、目标端口是用16位表示的，可推算计算机的端口个数为2^16个
- 序列号：表示本报文段所发送数据的第一个字节的编号。在TCP连接中所传送的字节流的每一个字节都会按顺序编号。由于序列号由32位表示，所以每2^32个字节，就会出现序列号回，再从0开始
- 确认号：表示接收方期望收到发送方下一个报文段的第一个字节数据的编号。也就是告诉发送发：我希望你（指发送方）下次发送的数据的第一个字节数据的编号是这个确认号
- 数据偏移：表示TCP报文段的首部长度，共4位，由于TCP首部包含一个长度可变的选项部分，需要指定这个TCP报文段到底有多长。它指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。该字段的单位是32位（即4个字节为计算单位） ， 4位二进制最大表示15，所以数据偏移也就是TCP首部最大60字节
- URG：表示本报文段中发送的数据是否包含紧急数据。后面的紧急指针字段（urgentpointer）只有当URG—1时才有效
- **ACK**：表示是否前面的确认号字段是否有效.ACK=1，表示有效。只有当ACK—1时，前面的确认号字段牙有效。TCP规定，连接建立后， ACK必须为1，带ACK标志的TCP报文段称为确认报文段
- PSH：提示接收端应用程序应该立即从TCP接收缓冲区中读走数据，为接收后续数据腾出空间。如果为1，则表示对方应当立即把数据提交给上层应用，而不是缓存起来，如果应用程序不将接收到的数据读走，就会一直停留在TCP接收缓冲区中
- RST：如果收到一个RST—1的报文，说明与主机的连接出现了严重错误（如主机崩溃） ，必须释放连接，然后再重新建立连接。或者说明上次发送给主机的数据有问题，主机拒绝响应，带RST标志的TCP报文段称为复位报文段
- **SYN**：在建立连接时使用，用来同步序号。当SYN—1， ACK—0时，表示这是一个请求建立连接的报文段；当SYN=1， ACK—1时，表示对方同意建立连接。SYN—1，说明这是一个请求建立连接或同意建立连接的报文。只有在前两次握手中SYN才置为1，带SYN标志的TCP报文段称为同步报文段
- **FIN**：表示通知对方本端要关闭连接了，标记数据是否发送完毕。如果FIN=1，即告诉对方：“我的数据已经发送完毕，你可以释放连接了” ，带FIN标志的TCP报文段称为结束报文段
- 窗口大小：表示现在允许对方发送的数据量，也就是告诉对方，从本报文段的确认号开始允许对方发送的数据量
- 校验和：提供额外的可靠性
- 紧急指针：标记紧急数据在数据字段中的位置
- 选项部分：其最大长度可根据TCP首部长度进行推算。TCP首部长度用4位表示，选项部分最长为：（2＾4 - 1）*4 - 20＝40字节
  - 常见选项：
  - 最大报文段长度：Maxium Segment Size， MSS  
    指明自己期望对方发送TCP报文段时那个数据字段的长度。默认是536字节。数据字段的长度加上TCP首部的长度才等于整个TCP报文段的长度。MSS不宜设的太大也不宜设的太小。若选择太小，极端情况下， TCP报文段只含有1字节数据，在IP层传输的数据报的开销至少有40字节（包括TCP报文段的首部和IP数据报的首部） 。这样，网络的利用率就不会超过1/41，若TCP报文段非常长，那么在IP层传输时就有可能要分解成多个短数据报片。在终点要把收到的各个短数据报片装配成原来的TCP报文段。当传输出错时还要进行重传，这些也都会使开销增大。因此MSS应尽可能大，只要在IP层传输时不需要再分片就行。在连接建立过程中，双方都把自己能够支持的MSS写入这一字段。MSS只出现在SYN报文中。即： MSS出现在SYN=1的报文段中。
  - 窗口扩大：Windows Scaling  
    为了扩大窗口，由于TCP首部的窗口大小字段长度是16位，所以其表示的最大数是6553S。但是随着时延和带宽比较大的通信产生（如卫星通信），需要更大的窗口来满足性能和吞吐率，所以产生了这个窗口扩大选项。
  - 时间戳：Timestamps  
    可以用来计篡RTT（往返时间),发送方发送TCP报文时，把当前的时间值放入时间戳字段，接收方收到后发送确认报文时，把这个时间戳字段的值复制到确认报文中，当发送方收到确认报文后即可计篡出RTTO也可以用来防止回绕序号PAWS，也可以说可以用来区分相同序列号的不同报文。因为序列号用32为表示，每2^32个序列号就会产生回绕，那么使用时间戳字段就很容易区分相同序列号的不同报文。

##### TCP三次握手

![](/assets/image_Linux/TCP三次握手.png)

##### TCP四次挥手

![](/assets/image_Linux/TCP四次挥手.png)

##### 客户端三次握手和四次挥手

![](/assets/image_Linux/客户端三四.png)

##### 服务端三次握手和四次挥手

![](/assets/image_Linux/服务端三四.png)

##### 有限状态机FSM

- CLOSED没有任何连接状态
- LISTEN侦听状态，等待来自远方TCP端口的连接请求
- SYN—SENT在发送连接请求后，等待对方确认
- SYN—RECEIVED在收到和发送一个连接请求后，等待对方确认
- ESTABLISHED代表传输连接建立，双方进入数据传送状态
- FIN—WAIT—1主动关闭，主机已发送关闭连接请求，等待对方确认
- FIN—WAIT—2主动关闭，主机已收到对方关闭传输连接确认，等待对方发送关闭传输连接请求
- TIME—WAIT完成双向传输连接关闭，等待所有分组消失
- LOSE—WAIT被动关闭，收到对方发来的关闭连接请求，并已确认
- LAST—ACK被动关闭，等待最后一个关闭传输连接确认，并等待所有分组消失
- CLOSING双方同时尝试关闭传输连接，等待对方确认
- 客户端先发送一个FIN给服务端，自己进入了FINWAIT_I状态，这时等待接收服务端的报文，该报文会有三种可能：
  - 只有服务端的ACK
  - 只有服务端的FIN
  - 基于服务端的ACK，又有FIN

- 1、只收到服务器的ACK，客户端会进入FIN_WAIT_2状态，后续当收到服务端的FIN
时，回应发送一个ACK，会进入到刊ME_WAIT状态，这个状态会持续2MSL（TCP报文段
在网络中的最大生存时间，RFC1122标准的建议值是2min）．客户端等待2MSL，是为了
当最后一个ACK丢失时，可以再发送一次。因为服务端在等待超时后会再发送一个FIN
给客户端，进而客户端知道ACK已丢失
- 2、只有服务端的FIN时，回应一个ACK给服务端，进入CLOSING态，然后接收到服务端的ACK时，进入到TMEWAIT状态
- 3、同时收到服务端的ACK和FIN，直接进入TIME_WAIT状态

##### 客户端的典型状态转移

- 客户端通过connect系统调用主动与服务器建立连接connect系统调用首先给服
务器发送一个同步报文段，使连接转移到SYN_SENT状态
- 此后connect系统调用可能因为如下两个原因失败返回：
  1. 如果connect连接的目标端囗不存在（未被任何进程监听），或者该端口仍
被处于TIME_WAIT状态的连接所占用（见后文），则服务器将给客户端发送一
个复位报文段，connect调用失败。
  2. 如果目标端口存在但connect在超时时间内未收到服务器的确认报文段，
则connect调用失败。
- connect调用失败将使连接立即返回到初始的CLOSED状态。如果客户端成功收到服务器的同步报文段和确认，则connect调用成功返回，连接转移至ESTABLISHED状态。
- 处于FINWAIT_2状态的客户端需要等待服务器发送结束报文段，才自孬专移至TIME_WAIT状态，否则它将一直停留在这个状态。如果不是为了在半关闭状态下继续接收数据连接长时间地停留在FIN_WAIT_2状态并无益处。连接停留在FINWAIT一2状态的情况可能发生在：客户端执行半关闭后，耒等服务器关闭连接就强行退了。此时客户端连接由内核来接管，可称之为孤儿连接（和孤儿进程类似）
- Linu×为了防止孤丿连接长时间存留在内核中，定义了两个内核参数
- /proc/sys/net/ipv4/tcp_max_orphans 指定内核能接管的孤儿连接数目
- /proc/sys/net/ipv4/tcp_fin_timeout 指定孤儿连接在内核中生存的时间

##### TCP超时重传

- 异常网络状况下（开始出现超时或丢包），TCP控制数据传输以保证其承诺的可
靠服务
- TCP服务必须能够重传超时时间内耒收到确认的TCP报文段。为此，TCP模块为
每个TCP报文段都维护一个重传定时器，该定时器在TCP报文段第一次被发送时
启动。如果超时时间内未收到接收方的应答，TCP模块将生传TCP报文段并重置
定时器。至于下次重传的超时时间如何选择，以及最多执行多少次重传，就是
TCP的重传策略
- 与TCP超时重传相关的两个内核参数
  1. /proc/sys/net/ipv4/tcp_retries1，指定在底层|P接管之前TCP最少执行的重传次数，默认值是3
  2. /proc/sys/net/ipv4/tcp_retries2,指定连接放弃前TCP最多可以执行的重传次数，默认值15（一般对应13、30min)

##### 端口号PORT

相当于应用程序的唯一标识

- 传输层通过port号，确定应用层协议
- Port number:
- tcp：传输控制协议，面向连接的协议；通信前需要建立虚拟链路；结束后拆除链路  
  0-65535
- udp：User Datagram Protocol，无连接的协议  
  0-65535
- IANA：互联网数字分配机构（负责域名，数字资源，协议分配）
  - 0—1023：系统端口特权端口（仅管理员可用），众所周知，永久的分配给固定的系统 应用使用，22/tcp（ssh），80/tcp（http），443/tcp（https）
  - 1024—49151：用户端口或注册端口，但要求并不严格，分配给程序注册为某应用使用， 1433/tcp(SqlServer), 1521/tcp(oracle),  
  3306/tcp(mysql),11211/tcp/udp (memcached)
  - 49152—65535：动态端口或私有端口，客户端程序随机使用的端口 
  - 其范围的定义：/proc/sys/net/ipv4/ip_local_port_range 
  - 查看哪些远程访问监听端口：ss -ntul

- **查看应用程序端口号**
在win 中:  

1. 看程序的进程编号PID:tasklist
2. 看连程序接端口号: netstat -no
3. 根据PID查看对应的端口

#### UDP特性

1. 工作在传输层
2. 提供不可靠的网络访问
3. 非面向连接协议
4. 有限的错误检查
5. 传输性能高
6. 无数据恢复特性

##### UDP包头

![](/assets/image_Linux/udp包头.png)

### internet层

对应OSI的网络层

#### 协议

- ip协议  
  - 运行于OSI网络层
  - 面向无连接的协议
  - 独立处理数据包
  - 分层编址
  - 尽力而为传输
  - 无数据恢复功能
- ICMP协议  
  泛洪，dos攻击：`ping *ip地址* -s 65507 -f` 
- IGMP协议
- ARP地址解析协议  
  把IP地址解析成mac地址  
  ARP通讯过程基于广播  
  查看arp表：arp -n

### 网络访问层

对应OSI的数据链路层和物理层

- 协议：Ethernet  


## 3.IP地址

### 私有IP地址

私有网络不能在互联网上直接访问，因为没有路由

- A： 10.0.0.0 到 10.255.255.255
- B： 176.16.0.0 到 172.31.255.255
- C: 192.168.0.0 到 192.168.255.255

### 特殊地址

- 0.0.0.0  
0.0.0.0不是一个真正意义上的IP地址。它表示一个集合：所有不清楚的主机和目的网络。
- 255.255.255.255  
限制广播地址。对本机来说，这个地址指本网段内（同一广播域）的所有主机
- 127.0.0.1 - 127.255.255.254  
本机回环地址，主要用于测试。在传输介质上永远不应该出现目的地址为“127.0.0.1”的数据包。
- 224.00.0到239.255.255.255  
组播地址， 224.0.0.1特指所有主机， 224.0.0.2特指所有路由器。224.0.0.5指OSPF路由器，地址多用于一些特定的程序以及多媒体程序
- 169.254.x.x  
如果Windows主机使用了DHCP自动分配IP地址，而又无法从DHCP服务器获取地址，系统会为主机分配这样地址。

## 4.跨网络通信

路由

### 路由分类

- 主机路由
- 网络路由
- 默认路由

### 优先级  

精度越高，优先级越高

### 路由表构成

1. 目标：数据包发送的目标路径
2. netmask
3. interface：路由器的出口
4. gateway:
   - 直连
   - 非直连

### 动态主机配置协议DHCP

![](/assets/image_Linux/DHCP.png)

### 网络配置方式

- 静态指定
  ifconfig,route,netstat  
  ip:object, ss, tc  
  setup
- 动态分配
  DHCP

#### ifconfig

默认显示活动网卡 

- `ifconfig -a`: 看到所有网卡，活动和非活动都能看
- `ifconfig eth1 down` ：禁用网卡eth1
- `ifconfig eth1 up` ：启用网卡eth1
- ip link：查看网线是否断
- 临时配置接口网址：ifconfig eth1 1.1.1.1/24 

#### 路由配置 route

- 添加主机路由：route add -host 6.6.6.6 gw 3.3.3.100 dev eth1 或 route add -net 6.6.6.6/32 gw 3.3.3.100
- 添加网络路由：route add -net 10.0.0.0/8 gw 192.168.30.100
- 添加默认路由: route add default gw 192.168.30.2 或 route add default dev ens33
- 重启网络服务：service network restart

#### 跟踪路由工具



### 网卡相关操作

- 查看网卡驱动：dmesg |grep -i eth 或 ethtool -i ens33
- 卸载网卡驱动：modprobe -r e1000
- 加载网卡驱动：modprobe e1000
- 网卡配置文件(可更改网卡名)：cat /etc/udev/rules.d/70-persistent-ipoib.rules
- 临时设置网卡地址：ifconfig eth1 1.1.1.1/24