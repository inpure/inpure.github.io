---
title: Shell脚本基础
tags: Linux Shell bash
---

Shell脚本基本语法、变量、逻辑运算

<!--more-->  

## shell脚本：

包含一些命令或声明，并符合一定格式的文本文件

### 格式要求：首行shebang机制

- #!/bin/bash 
- #!/usr/bin/python
- #!/usr/bin/perl 
  
### shell脚本的用途有：

- 自动化常用命令
- 执行系统管理和故障排除
- 创建简单的应用程序 
- 处理文本或文件 

## 创建shell脚本

1. 第一步：使用文本编辑器来创建文本文件
   - 第一行必须包括shell声明序列：#！  
     #!/bin/bash 
   - 添加注释注释  
     以#开头
2. 第二步：运行脚本
   - 给予执行权限，在命令行上指定脚本的绝对或相对路径: `. file.sh`
   - 直接运行解释器，将脚本作为解释器程序的参数运行: `bash file.sh`或`cat fele.sh | bash`


### 脚本代码开头约定

1. 第一行一般为调用使用的语言
2. 程序名，避免更改文件名为无法找到正确的文件
3. 版本号
4. 更改后的时间
5. 作者相关信息
6. 该程序的作用，及注意事项
7. 最后是各版本的更新简要说明

### 示例

```shell
# !/bin/bash
# ----------------------------------
# Filename: hello.sh 
# Revision: 1.1
# Date: 2017/06/01 
# Author: wang
# Email: wang@gmail.com 
# Website: www.magedu.com 
# Description: This is the first script 
# ---------------------------------------
# Copyright: 2017 wang 
# License: GPL
echo "hello world"
```

### 配置文件

在家目录 .vimrc 里添加sh文件默认配置

## 脚本执行过程

默认是有错没错的地方都执行

### 检测脚本语法错误

bash -n file.sh: 先检查语法再执行，有语法错误不执行

### 跟踪调试执行

bash -x file.sh

### 退出状态

- 进程使用退出状态来报告成功或者失败
  - 0 代表成功， 1-255 表示失败
  - $? 变量保存最近的命令退出状态
- 例子：
  ```bash
  ping -c1 -W1 hostdown &> /dev/null  
  echo $?
  ```

## 变量

1. 字符
2. 数值： 整形、**浮点型(bash不支持)**
3. 强类型：变量不经过强制转换，它永远是这个数据类型，不允许隐式的类型转
换。一般定义变量时必须指定类型、参与运算必须符合类型要求；调用未声明
变量会产生错误  
如 java,c#
4. 弱类型：语言的运行时舍隐式做数据类型转换。无须指定类型，默认均为字符
型；参与运算会自动进行隐式类型转换；变量无彡页事先定义可直接调用  
如：bash 不支持浮点数，php
5. 变量命名法则：
   1. 不能使程序中的保留字：例如 if, for
   2. 只能使用数字、字母及下划线，且不能以数字开头
   3. 见名知义
   4. 统一命名规则：驼峰命名法

### 局部变量

生效范围为当前shell 进程，对当前进程之外的进程无效，包括子shell进程

### 环境（全局）变量

生效范围为当前shell进程及其子进程  
声明环境变量：`declare -x name` 或 `export name`    
变量引用：$name, ${name}  
显示所有环境变量：  

- env
- printenv
- export
- declare -x  

删除变量：`unset name`

#### 系统自带环境变量

- $SHLVL : shell 嵌套深度
- $_ : 前一个命令的最后一个字符串

### 只读变量

就是常量。只能声明，不能修改和删除

- 声明：readonly name 或 declare -r name  
- 查看：readonly -p

### 位置变量

在脚本代码中调用通过命令行传递给脚本的参数
- $1，$2,...：对应第1、第2等参数，shift[n]换位置
- $0：命令本身
- $*：传递给脚本的所有参数，全部参数合为一个字符串
- $@：传递给脚本的所有参数，每个参数为独立字符串
- \$#：传递给脚本的参数的个数  
  $@ $* 只在被双引号包起来的时候才会有差异
- **set -- 清空所有位置变量**


### tip

- `echo $name` 和`echo "$name"`显示结果不一样，后者会保留格式 。比如当

    ```shell
    name=`cat /etc/passwd`
    ```

- **自编脚本变量，使用完毕之后，一般建议用 unset 删除，否则程序运行期间变量会一直在内存中不会释放空间。**
- (cmd1;cmd2;...) 和 {cmd1;cmd2;...}  
  - ()在子shell 执行
    - 一次性的，
    - 执行完后不影响当前环境，
    - 这里的子shell 和前面的子进程并不完全一样  
  - {}在当前shell 执行

## 算术运算

+，-，*，/，%取模(取余)，**乘方  

bash中的算术运:help let
实现算术运算：

1. let var：算术表达式
2. var=$[算术表达式]
3. var=$((算术表达式))
4. var=$(expr argl arg2 arg3...)
5. declare -i var=数值
6. echo '算术表达式'|bc
7. &,|  与，或
8. &&，|| 短路与，短路或 

乘法符号有些场景中需要转义，如*  
bash有内建的随机数生成器：\$RANDOM（0一32767）  
echo$[$RANDOM%50]：0一49之间随机数

### 示例

1. 随机颜色显示"color": `COLOR=$[RANDOM%7+31];echo -e "\e[1;${COLOR}mcolor\e[0m"`

## 逻辑条件运算

可 help test 查看帮助

- 判断字符串是否相等：

  ```shell
  test $s1 = $s2    #注意等号两边要有空格
  echo $?          #结果为0才相等
  ```

  或

  ```shell
  [ $s1 = $s2 ]    #注意空格
  echo $?               #结果为0才相等
  ```

- 判断字符串是否为空
  
  ```shell
  [ -z $str ]
  echo $?           #结果0为空
  ```
- 判断字符串是否非空
  
  ```shell
  [ -n $str ] 或 [ $str ]
  echo $?           #结果0为非空
  ```

- 判断数字是否相等：  
  `[ $n1 -eq $n2 ]`

- 判断是否是文件夹:  
  `[ -d /dir/file ]`

- 其他 option 判断请参考文档：help test

### bash 的字符串测试

- = 是否等于
- \> ascii码是否大于ascii码 
- < 是否小于
- != 是否不等于
- =~ 左侧字符串是否能够被右侧的PATTERN所匹配  
  注意：此表达式一般用于[[]]中；扩展的正则表达式
  - 例：判断变量是否为数字并打印提示：  
   `[[ "$n" =~ ^[[:digit:]]+$ ]] && echo digit || echo not digit`
- -z "STRING" 字符串是否为空，空为真，不空为假
- -n "STRING" 字符串是否不空，不空为真，空为假  

注意：用于字符串比较时的用到的操作数都应该使用引号

## (cmd1; cmd2...) 和 {cmd1; cmd2...}

- **都是把命令组合到一起,区别是()会开启子进程，{}就在当前进程执行**
- **在脚本中用{}，否则(cmd; exit) 退不出去,还会执行后面的脚本**